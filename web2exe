#!/bin/bash
set -euo pipefail

# Input check
[[ $# -lt 1 ]] && { echo "Usage: $0 <html_file>"; exit 1; }
INPUT="$1"
[[ ! -f "$INPUT" ]] && { echo "Error: $INPUT does not exist"; exit 1; }

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
OUT_DIR="$PWD"

# Handle .html or .htm
BASENAME=$(basename "$INPUT")
BASENAME=${BASENAME%.html}
BASENAME=${BASENAME%.htm}
TITLE=$(grep -ioP '(?<=<title>).*?(?=</title>)' "$INPUT" || echo "$BASENAME")

mkdir -p /tmp/web2exe

# Windows SDK download
[[ ! -f /tmp/web2exe/.sdk_download_complete ]] && {
    echo "→ Downloading Windows SDK..."
    mkdir -p /tmp/web2exe/xwin
    xwin --cache-dir /tmp/web2exe/xwin --arch x86 download
    touch /tmp/web2exe/.sdk_download_complete
}

# Windows SDK splat
[[ ! -f /tmp/web2exe/.sdk_splat_complete ]] && {
    echo "→ Installing Windows SDK (splat)..."
    xwin --cache-dir /tmp/web2exe/xwin --arch x86 splat
    touch /tmp/web2exe/.sdk_splat_complete
}

# WebView2 download & unpack
[[ ! -f /tmp/web2exe/.webview2_complete ]] && {
    echo "→ Downloading & unpacking WebView2 SDK..."
    rm -rf /tmp/web2exe/webview2
    mkdir -p /tmp/web2exe/webview2
    wget -O /tmp/web2exe/webview2.nupkg https://www.nuget.org/api/v2/package/Microsoft.Web.WebView2/
    unzip -q /tmp/web2exe/webview2.nupkg -d /tmp/web2exe/webview2
    rm /tmp/web2exe/webview2.nupkg
    touch /tmp/web2exe/.webview2_complete
}

# Convert files to byte arrays
HTML_BYTES=$(hexdump -v -e '1/1 "0x%02X, "' "$INPUT" | sed 's/, $//')
DLL_BYTES=$(hexdump -v -e '1/1 "0x%02X, "' /tmp/web2exe/webview2/runtimes/win-x86/native/WebView2Loader.dll | sed 's/, $//')
HTML_LEN=$(stat -c %s "$INPUT")
DLL_LEN=$(stat -c %s /tmp/web2exe/webview2/runtimes/win-x86/native/WebView2Loader.dll)

# Prepare source code
SOURCE=$(<"$SCRIPT_DIR/index.c")
SOURCE=${SOURCE//"/*HTML_DATA_PLACEHOLDER*/"/$HTML_BYTES}
SOURCE=${SOURCE//"/*HTML_LEN_PLACEHOLDER*/"/$HTML_LEN}
SOURCE=${SOURCE//"/*DLL_DATA_PLACEHOLDER*/"/$DLL_BYTES}
SOURCE=${SOURCE//"/*DLL_LEN_PLACEHOLDER*/"/$DLL_LEN}
SOURCE=${SOURCE//"/*WINDOW_NAME*/"/$TITLE}
echo "$SOURCE" > /tmp/web2exe/"$TITLE".c

# Compile
clang -std=c89 -Os -ffunction-sections -fdata-sections \
    -I /tmp/web2exe/xwin/splat/crt/include/ \
    -I /tmp/web2exe/xwin/splat/sdk/include/shared/ \
    -I /tmp/web2exe/xwin/splat/sdk/include/ucrt/ \
    -I /tmp/web2exe/xwin/splat/sdk/include/um/ \
    -I /tmp/web2exe/webview2/build/native/include/ \
    -I /tmp/web2exe/xwin/splat/sdk/include/winrt/ \
    --target=i686-pc-windows-msvc \
    -c /tmp/web2exe/"$TITLE".c -o /tmp/web2exe/"$TITLE".obj

# Link executable
lld-link /OUT:"$OUT_DIR/$TITLE.exe" /SUBSYSTEM:WINDOWS /BREPRO /NODEFAULTLIB \
    /LIBPATH:/tmp/web2exe/xwin/splat/crt/lib/x86/ \
    /LIBPATH:/tmp/web2exe/xwin/splat/sdk/lib/ucrt/x86/ \
    /LIBPATH:/tmp/web2exe/xwin/splat/sdk/lib/um/x86/ \
    /LIBPATH:/tmp/web2exe/webview2/build/native/x86/ \
    /tmp/web2exe/"$TITLE".obj /FIXED \
    /tmp/web2exe/xwin/splat/sdk/lib/um/x86/user32.lib \
    /tmp/web2exe/xwin/splat/sdk/lib/um/x86/kernel32.lib \
    WebView2Loader.dll.lib